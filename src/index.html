<!DOCTYPE html>
<html>
<head>
    <title>METAR data for airports</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="./css/leaflet.css"/>
    <link rel="stylesheet" href="./css/MarkerCluster.css" />
    <link rel="stylesheet" href="./css/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="./css/airportWeather.css" />

    <script src="./js/leaflet.js"></script>
    <script src="./js/leaflet.markercluster.js"></script>
    <script src="./js/MetarParser.js"></script>
</head>
<body>
<div id="map" style="display: block; width: 100%; height: 100%;"></div>

<script>
    var baseUrl = './proxy.php?csurl=http%3A%2F%2Ftgftp.nws.noaa.gov%2Fdata%2Fobservations%2Fmetar%2Fstations%2F'
    var map = L.map('map').setView([50.865833, 7.142778], 8)

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map)

    var popup = L.popup()

    function makeAirportTableContent(data) {
      rows = []
      for (var i = 0; i < data.length; i++) {
        if (data[i][0] === 'Airport') {
          rows.push('<th class="airport">' + data[i][0] + '</th><td class="airport">' + data[i][1] + '</td>')
        } else {
          rows.push('<th>' + data[i][0] + '</th><td>' + data[i][1] + '</td>')
        }
      }
      return '<tr>' + rows.join('</tr><tr>') + '</tr>'
    }

    function toDegMinSec(value) {
      var deg = Math.floor(value)
      value = (value - deg) * 60
      var min = Math.floor(value)
      return deg + '°' + min + '′' + ((value - min) * 60).toFixed(3) + '″'
    }

    function processAirportsData(data) {
      var airports = JSON.parse(data)
      var markers = L.markerClusterGroup();

      var geoJsonLayer = L.geoJson(airports, {
        'pointToLayer': function (feature, latlng) {
          var smallIcon =  new L.Icon({
            iconSize: [36, 64],
            iconAnchor: [18, 64],
            iconUrl: 'images/airport-marker.png'
          });
          return L.marker(latlng, {icon: smallIcon});
        }
      });

      markers.addLayer(geoJsonLayer);
      map.addLayer(markers);

      markers.on('click', function (e) {
        var feature =  e.layer.feature.properties

        var value = feature.lon
        var suffix = '&nbsp;' + ((value < 0) ? 'W' : 'E')
        value = Math.abs(value)
        var lon = value.toFixed(6) + '°' + suffix + ' / ' + toDegMinSec(value) + suffix
        value = feature.lat
        var suffix = '&nbsp;' + ((value < 0) ? 'S' : 'N')
        value = Math.abs(value)
        var lat = value.toFixed(6) + '°' + suffix + ' / ' + toDegMinSec(value) + suffix

        var alt = (feature.alt * 0.3048).toFixed(2) // in meters

        var fixedData =  makeAirportTableContent([
            ['Airport', feature.name],
            ['ICAO', feature.icao],
            ['Location', feature.place],
            ['Country', feature.country],
            ['Longitude', lon ],
            ['Latitude', lat],
            ['Altitude', alt + ' meters AMSL']
          ])

        popup
          .setContent(
            '<table>' + fixedData + '</table>' +
            '<div id="loading"><img src="images/loading.svg"></div>'
          )
          .setLatLng([e.latlng.lat, e.latlng.lng])
          .openOn(map)

        function processStationData (data) {
          var metarData = new MetarParser(data)
          popup
            .setContent(
              '<table>' + fixedData +
                    makeAirportTableContent([
                      ['Pressure', metarData.getPressureDescription()],
                      ['Temperature', metarData.getTemperatureDescription()],
                      ['Dew Point', metarData.getDewPointDescription()],
                      ['Visibility', metarData.getVisibilityDescription()],
                      ['RAW DATA', metarData.getRawMetarData()]
                    ]) +
              '</table>'
            )
            .setLatLng([e.latlng.lat, e.latlng.lng])
            .openOn(map)
        }

        function stationHandler() {
          if(this.status === 200 && this.responseText != null) {
            processStationData(this.responseText)
          }
        }

        var stationClient = new XMLHttpRequest()

        stationClient.onload = stationHandler
        stationClient.open('GET', baseUrl + feature.icao + '.TXT')
        stationClient.send()
      })
    }

    function airportsHandler() {
      if(this.status === 200 && this.responseText != null) {
        processAirportsData(this.responseText)
      }
    }

    var airportsClient = new XMLHttpRequest()

    airportsClient.onload = airportsHandler
    airportsClient.open('GET', './data/airports.geojson')
    airportsClient.send()
</script>

</body>
</html>
